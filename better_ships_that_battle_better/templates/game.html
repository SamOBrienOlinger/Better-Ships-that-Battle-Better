{% extends 'base.html' %}

{% block title %}Battle - Better Ships that Battle Better{% endblock %}

{% block content %}
<div class="container narrow">
    {% if user.is_authenticated %}
        <div class="text-center mb-20">
            <h2>‚öì Welcome aboard, {% if profile %}{{ profile.pirate_name }}{% else %}Captain {{ user.username }}{% endif %}!</h2>
            {% if profile %}
                <p>Difficulty: {{ profile.get_preferred_difficulty_display }} | Shots Available: {{ shots_available }}</p>
            {% endif %}
        </div>
    {% else %}
        <div class="text-center mb-20">
            <h2>‚öì Naval Battle Simulation</h2>
            <p>Playing as Guest | Difficulty: Normal | Shots Available: 20</p>
        </div>
    {% endif %}

    <div id="game-container" class="game-container" data-shots="{{ shots_available }}" data-auth="{% if user.is_authenticated %}true{% else %}false{% endif %}" data-save-url="{% url 'save_game_result' %}">
        <div id="game-status" class="game-status panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <strong>Shots Remaining:</strong>
                    <div id="shots-remaining" class="stat-number">{{ shots_available }}</div>
                </div>
                <div class="stat-card">
                    <strong>Ships Sunk:</strong>
                    <div id="ships-sunk" class="stat-number">0/5</div>
                </div>
                <div class="stat-card">
                    <strong>Status:</strong>
                    <div id="game-state">Ready to Fire!</div>
                </div>
            </div>
        </div>

        <div id="battlefield" class="battlefield panel">
            <div id="grid" class="grid">
                <!-- Grid cells will be generated by JavaScript -->
            </div>
        </div>

        <div class="text-center mt-30">
            <button id="new-game-btn" class="btn">üéØ New Battle</button>
            {% if user.is_authenticated %}
                <a href="{% url 'dashboard' %}" class="btn ml-10">üìä Dashboard</a>
            {% endif %}
        </div>

        <div id="instructions" class="panel">
            <h3 class="text-center">‚öîÔ∏è Battle Instructions</h3>
            <ul><li>üéØ Click on grid squares to fire your cannons</li><li>üí• Red squares indicate successful hits on enemy ships</li><li>üåä Blue squares show missed shots in empty water</li><li>üö¢ Find and sink all 5 enemy ships to achieve victory</li><li>‚ö° Ships are randomly placed: 1 Carrier (5 cells), 1 Battleship (4 cells), 1 Cruiser (3 cells), 1 Submarine (3 cells), 1 Destroyer (2 cells)</li>{% if user.is_authenticated and profile %}<li>üèÜ Your battle results will be saved to your profile</li>{% endif %}</ul>
        </div>
    </div>
</div>

<script>
class BattleshipGame {
    constructor() {
        const container = document.getElementById('game-container');
        this.grid = [];
        this.ships = [];
        this.initialShots = parseInt(container.dataset.shots || '15', 10);
        this.shotsRemaining = this.initialShots;
        this.isAuthenticated = (container.dataset.auth === 'true');
        this.saveUrl = container.dataset.saveUrl;
        this.shipsSunk = 0;
        this.totalShips = 5;
        this.gameStartTime = null;
        this.gameActive = false;
        this.shotsFired = 0;
        
        this.initializeGrid();
        this.placeShips();
        this.renderGrid();
        this.setupEventListeners();
    }
    
    initializeGrid() {
        this.grid = [];
        for (let i = 0; i < 8; i++) {
            this.grid[i] = [];
            for (let j = 0; j < 8; j++) {
                this.grid[i][j] = {
                    hasShip: false,
                    hit: false,
                    shipId: null
                };
            }
        }
    }
    
    placeShips() {
        const shipSizes = [5, 4, 3, 3, 2]; // Carrier, Battleship, Cruiser, Submarine, Destroyer
        this.ships = [];
        
        for (let i = 0; i < shipSizes.length; i++) {
            let placed = false;
            let attempts = 0;
            
            while (!placed && attempts < 100) {
                const horizontal = Math.random() < 0.5;
                const size = shipSizes[i];
                
                let row, col;
                if (horizontal) {
                    row = Math.floor(Math.random() * 8);
                    col = Math.floor(Math.random() * (8 - size + 1));
                } else {
                    row = Math.floor(Math.random() * (8 - size + 1));
                    col = Math.floor(Math.random() * 8);
                }
                
                if (this.canPlaceShip(row, col, size, horizontal)) {
                    this.placeShip(row, col, size, horizontal, i);
                    placed = true;
                }
                attempts++;
            }
        }
    }
    
    canPlaceShip(row, col, size, horizontal) {
        for (let i = 0; i < size; i++) {
            const r = horizontal ? row : row + i;
            const c = horizontal ? col + i : col;
            
            if (r >= 8 || c >= 8 || this.grid[r][c].hasShip) {
                return false;
            }
        }
        return true;
    }
    
    placeShip(row, col, size, horizontal, shipId) {
        const ship = { id: shipId, cells: [], hits: 0, sunk: false };
        
        for (let i = 0; i < size; i++) {
            const r = horizontal ? row : row + i;
            const c = horizontal ? col + i : col;
            
            this.grid[r][c].hasShip = true;
            this.grid[r][c].shipId = shipId;
            ship.cells.push({ row: r, col: c });
        }
        
        this.ships.push(ship);
    }
    
    renderGrid() {
        const gridElement = document.getElementById('grid');
        gridElement.innerHTML = '';
        
        for (let i = 0; i < 8; i++) {
            for (let j = 0; j < 8; j++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.row = i;
                cell.dataset.col = j;
                
                let backgroundColor = '#003300';
                let cursor = 'pointer';
                
                if (this.grid[i][j].hit) {
                    if (this.grid[i][j].hasShip) {
                        backgroundColor = '#ff0000'; // Hit
                        cell.innerHTML = 'üí•';
                    } else {
                        backgroundColor = '#0066cc'; // Miss
                        cell.innerHTML = 'üåä';
                    }
                    cursor = 'default';
                }
                
                cell.style.cssText = `
                    width: 50px;
                    height: 50px;
                    background-color: ${backgroundColor};
                    border: 1px solid #0048ff45;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: ${cursor};
                    font-size: 20px;
                    transition: background-color 0.3s;
                `;
                
                if (!this.grid[i][j].hit) {
                    cell.addEventListener('mouseenter', () => {
                        if (this.gameActive) {
                            cell.style.backgroundColor = '#006600';
                        }
                    });
                    
                    cell.addEventListener('mouseleave', () => {
                        if (this.gameActive) {
                            cell.style.backgroundColor = '#003300';
                        }
                    });
                }
                
                gridElement.appendChild(cell);
            }
        }
    }
    
    setupEventListeners() {
        document.getElementById('grid').addEventListener('click', (e) => {
            if (e.target.classList.contains('grid-cell') && this.gameActive) {
                const row = parseInt(e.target.dataset.row);
                const col = parseInt(e.target.dataset.col);
                this.fireShot(row, col);
            }
        });
        
        document.getElementById('new-game-btn').addEventListener('click', () => {
            this.startNewGame();
        });
    }
    
    fireShot(row, col) {
        if (this.grid[row][col].hit || !this.gameActive) {
            return;
        }
        
        if (!this.gameStartTime) {
            this.gameStartTime = Date.now();
        }
        
        this.grid[row][col].hit = true;
        this.shotsRemaining--;
        this.shotsFired++;
        
        let hit = false;
        if (this.grid[row][col].hasShip) {
            hit = true;
            const shipId = this.grid[row][col].shipId;
            this.ships[shipId].hits++;
            
            if (this.ships[shipId].hits === this.ships[shipId].cells.length) {
                this.ships[shipId].sunk = true;
                this.shipsSunk++;
                this.updateStatus(`Ship Sunk! ${this.shipsSunk}/5 ships destroyed`);
            } else {
                this.updateStatus('Direct Hit! üí•');
            }
        } else {
            this.updateStatus('Miss! üåä');
        }
        
        this.renderGrid();
        this.updateUI();
        
        // Check win/lose conditions
        if (this.shipsSunk === this.totalShips) {
            this.endGame(true);
        } else if (this.shotsRemaining === 0) {
            this.endGame(false);
        }
    }
    
    updateUI() {
        document.getElementById('shots-remaining').textContent = this.shotsRemaining;
        document.getElementById('ships-sunk').textContent = `${this.shipsSunk}/${this.totalShips}`;
    }
    
    updateStatus(message) {
        document.getElementById('game-state').textContent = message;
    }
    
    startNewGame() {
        this.gameActive = true;
        this.gameStartTime = null;
        this.shotsRemaining = this.initialShots;
        this.shipsSunk = 0;
        this.shotsFired = 0;
        
        this.initializeGrid();
        this.placeShips();
        this.renderGrid();
        this.updateUI();
        this.updateStatus('Ready to Fire! üéØ');
        
        document.getElementById('new-game-btn').textContent = 'üéØ New Battle';
    }
    
    endGame(won) {
        this.gameActive = false;
        const duration = this.gameStartTime ? Math.floor((Date.now() - this.gameStartTime) / 1000) : null;
        
        if (won) {
            this.updateStatus('üèÜ VICTORY! All enemy ships destroyed!');
        } else {
            this.updateStatus('üíÄ DEFEAT! You ran out of ammunition!');
            // Reveal remaining ships
            this.revealShips();
        }
        
        document.getElementById('new-game-btn').textContent = 'üéØ New Battle';
        
        // Save game result if user is authenticated
        if (this.isAuthenticated) {
            this.saveGameResult(won, duration);
        }
    }
    
    revealShips() {
        for (let i = 0; i < 8; i++) {
            for (let j = 0; j < 8; j++) {
                if (this.grid[i][j].hasShip && !this.grid[i][j].hit) {
                    const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
                    cell.style.backgroundColor = '#666600';
                    cell.innerHTML = 'üö¢';
                }
            }
        }
    }
    
    saveGameResult(won, duration) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const data = {
            result: won ? 'win' : 'loss',
            shots_fired: this.shotsFired,
            ships_sunk: this.shipsSunk,
            duration_seconds: duration
        };
        
        fetch(this.saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Game result saved successfully');
            }
        })
        .catch(error => {
            console.error('Error saving game result:', error);
        });
    }
}

// Initialize the game when the page loads
document.addEventListener('DOMContentLoaded', function() {
    const game = new BattleshipGame();
    game.startNewGame();
});
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}
